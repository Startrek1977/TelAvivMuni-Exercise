name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history so Claude can diff against the base branch

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this pull request for a .NET 8 WPF application following MVVM
            architecture with Repository + Unit of Work + Dependency Injection patterns.

            Focus on:
            - MVVM correctness: no code-behind logic, proper use of RelayCommand /
              ObservableProperty (CommunityToolkit.Mvvm)
            - WPF theming: StaticResource only (no DynamicResource), brush keys
              defined in theme assemblies, no hard-coded colors in views
            - Naming conventions: interfaces I{Name}, ViewModels {Feature}ViewModel,
              repositories {Entity}Repository, behaviors {Action}Behavior
            - Repository / UnitOfWork pattern correctness
            - OperationResult usage for error handling (no raw exceptions as control flow)
            - Test coverage: new public methods should have corresponding unit tests
              (xUnit + Moq, naming pattern {Method}_{Condition}_{Expected})
            - Pack URI correctness for cross-assembly XAML resources
            - Any build warnings or obvious bugs

            Additionally, enforce the following project-specific guidelines:

            ## Category 1 — MVVM Purity (Highest Priority)

            G1. No logic in code-behind files.
            *.xaml.cs must contain only InitializeComponent() and optionally a ContentRendered
            handler calling viewModel.Initialize() (canonical example: DataBrowserDialog.xaml.cs).
            Flag anything else.

            G2. UI event handlers must live in attached behaviors, not Views.
            If a XAML file wires a UI event to a code-behind method, flag it. Use a static
            [ExcludeFromCodeCoverage] behavior class with attached properties (e.g.,
            DialogCloseBehavior, AutoFocusSearchBehavior).

            G3. ViewModels must not reference WPF types.
            Flag MessageBox, Window, Application.Current, or System.Windows.Controls.* in any
            ViewModel. Only System.Windows.Input (ICommand) is permitted.

            ## Category 2 — CommunityToolkit.Mvvm

            G4. Simple observable properties must use [ObservableProperty].
            Backing fields with no setter side-effects belong in a partial class : ObservableObject.
            Manual SetProperty is only justified when extra logic runs in the setter.

            G5. Commands must use [RelayCommand] on private async methods.
            Methods must be private, suffixed Async when returning Task, in a partial class.
            Exception: DataBrowserDialogViewModel (non-partial, approved legacy).

            G6. NotifyCanExecuteChanged must be wired for state-dependent commands.
            Every [RelayCommand] with a CanExecute predicate must call
            <Name>Command.NotifyCanExecuteChanged() in the setter of any property that predicate reads.

            ## Category 3 — Repository and Unit of Work

            G7. Inject interfaces, not concrete types.
            ViewModels receive IUnitOfWork; repositories receive IDataStore<TEntity>. Flag constructor
            parameters typed as ProductRepository, UnitOfWork, etc.

            G8. ViewModels call SaveChangesAsync() on IUnitOfWork only.
            Flag direct calls to _repository.SaveAsync() from ViewModels — that belongs exclusively
            inside UnitOfWork.cs.

            G9. All entity reads must call EnsureLoadedAsync() first.
            Any new repository method accessing _entities must await EnsureLoadedAsync() before doing so.

            G10. Repository CRUD return values (OperationResult) must be checked.
            Flag callers that discard the returned OperationResult or call SaveChangesAsync() without
            first confirming result.Success.

            ## Category 4 — Custom Controls and Dependency Properties

            G11. UI classes must carry [ExcludeFromCodeCoverage].
            Any class inheriting from Control, UserControl, Window, or a behavior must be decorated
            with it. Flag missing attributes.

            G12. OnApplyTemplate must unsubscribe before resubscribing.
            Pattern from DataBrowserBox: null-check old part → unsubscribe → GetTemplateChild("PART_...")
            → resubscribe. Skipping the unsubscribe step causes memory leaks.

            G13. Two-way bindable DependencyProperty must use BindsTwoWayByDefault.
            Any DependencyProperty representing a selected or editable value must use
            FrameworkPropertyMetadata with FrameworkPropertyMetadataOptions.BindsTwoWayByDefault
            (see SelectedItemProperty in DataBrowserBox).

            ## Category 5 — Dependency Injection Lifetimes

            G14. Repositories/services → Singleton; ViewModels → Transient.
            In App.xaml.cs / ConfigureServices, flag AddScoped (no HTTP scope in WPF), and flag
            Singletons that hold mutable state shared unsafely across ViewModels.

            G15. ViewModelLocator.Resolve<T>() is only for XAML DataContext bridging.
            Flag any call to it from C# code (ViewModels, services, repositories) — those classes
            use constructor injection.

            ## Category 6 — Async/Await and Error Handling

            G16. Every Task-returning method must be named with the Async suffix.
            Applies to public, internal, private methods, interface implementations, and local functions.

            G17. async void is prohibited except in WPF event handlers on [ExcludeFromCodeCoverage] controls.
            Approved fire-and-forget pattern in constructors: _ = LoadProductsAsync() with try/catch
            inside the async method.

            G18. Exceptions must surface through ErrorMessage, not be swallowed.
            ViewModel command methods must use try/catch and assign ErrorMessage = $"<context>: {ex.Message}".
            Flag empty catch blocks.

            ## Category 7 — Testing Conventions

            G19. Test method names must follow {Method}_{Condition}_{Expected}.
            Example: AddAsync_WithNullEntity_ReturnsFailResult. Flag Should_, When_, or free-form naming.

            G20. New public methods on non-UI classes require tests for both happy and failure paths.
            If a PR adds or modifies a repository, ViewModel, or service method without a corresponding
            test file change, flag it — unless the class carries [ExcludeFromCodeCoverage].

            Post a concise structured review with these sections:
            **Summary**, **Issues** (if any), **Suggestions**, **Verdict**.
          claude_args: "--max-turns 5"

